<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
      integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <%- include('./components/head.ejs') %>
    <link rel="stylesheet" href="/css/add.css" />
    <title><%= title %></title>
  </head>
  <div class="alert alert-success alert-dismissible fade show mt-3" id="alert-success" role="alert" style="position: fixed; top: 0; left: 0; width: 80%; z-index: 1000; margin-left: 10rem;" hidden>
    <strong>Điểm đặt quảng cáo được tạo thành công!</strong>
    <button type="button" class="btn-close"></button>
  </div>
  
  <div class="alert alert-danger alert-dismissible fade show mt-3" id="alert-danger" role="alert" style="position: fixed; top: 0; left: 0; width: 80%; z-index: 1000; margin-left: 10rem;" hidden>
    <strong>Có lỗi xảy ra khi tạo điểm đặt quảng cáo!</strong>
    <button type="button" class="btn-close"></button>
  </div>
  
  <div class="alert alert-warning alert-dismissible fade show mt-3" id="alert-warning" role="alert" style="position: fixed; top: 0; left: 0; width: 80%; z-index: 1000; margin-left: 10rem;" hidden>
    <strong id="warning-text">Vui lòng nhập đầy đủ và chính xác các trường thông tin!</strong>
    <button type="button" class="btn-close"></button>
  </div>

  <body>
    <%- include('./components/sidebar.ejs'); %>
    <div class="container">
      <h1>Tạo điểm đặt quảng cáo mới</h1>
      <form action="" method="">
          <div class="image drag-area">
            <img src="/assets/addImage.jpg" alt="">
            <div class="dragText">Kéo và thả để tải hình ảnh lên</div>
            <div class="or">hoặc</div>
            <button>Chọn hình ảnh cho điểm đặt</button>
            <input type="file" id="input-image" accept="image/*" hidden multiple>
          </div>
          <div class="formContent">
            <div class="item-container">
              <div class="item-title">
                <label for="name-field">Điểm đặt</label>
                <span id="reName">*</span>
              </div>
              <input
                type="text"
                id="name-field"
                name="name"
                placeholder="Tên điểm đặt mới"
                required
                autofocus
              />
            </div>
    
            <div class="coor">
              <div class="item-container">
                <div class="item-title">
                  <label for="long-field">Kinh độ</label>
                </div>
                <input
                  type="number"
                  id="long-field"
                  name="long"
                  placeholder="Kinh độ của điểm đặt"
                  disabled
                />
              </div>
  
              <div class="item-container">
                <div class="item-title">
                  <label for="lat-field">Vĩ độ</label>
                </div>
                <input
                  type="number"
                  id="lat-field"
                  name="lat"
                  placeholder="Vĩ độ của điểm đặt"
                  disabled
                />
              </div>
            </div>
  
            <div class="item-container">
              <div class="item-title">
                <label for="address-field">Địa chỉ</label>
              </div>
              <input
                type="text"
                id="address-field"
                name="address"
                placeholder="Địa chỉ của điểm đặt mới"
                disabled
              />
            </div>
  
            <div class="addDetail">
              <div class="item-container">
                <div class="item-title">
                  <label for="ward-field">Phường</label>
                </div>
                <input
                  type="text"
                  id="ward-field"
                  name="ward"
                  placeholder="Tên phường của điểm đặt"
                  disabled
                />
                <input type="text" class="form-control" id="ward" hidden />
              </div>
              <div class="item-container">
                <div class="item-title">
                  <label for="district-field">Quận</label>
                </div>
                <input
                  type="text"
                  id="district-field"
                  name="district"
                  placeholder="Tên quận của điểm đặt"
                  disabled
                />
                <input type="text" class="form-control" id="district" hidden />
              </div>
            </div>
  
            <div class="item-container">
              <div class="item-title">
                <label for="locationtype">Loại vị trí</label>
                <span id="reName">*</span>
              </div>
              <input type="text" class="form-control" id="locationtype" list="spotTypeList" />
                <input type="text" class="form-control" id="spotType" hidden />
                <datalist id="spotTypeList" style="display: none;">
                  <% other.spottypes.forEach((type)=> { %>
                    <option value="<%= type.locationTypeName; %>"></option>
                    <% }); %>
                </datalist>
            </div>
  
            <div class="item-container">
              <div class="item-title">
                <label for="adCategory">Hình thức quảng cáo</label>
                <span id="reName">*</span>
              </div>
              <input type="text" class="form-control" id="adCategory" list="adsFormList" />
                <input type="text" class="form-control" id="adsForm" hidden />
                <datalist id="adsFormList" style="display: none;">
                  <% other.adsforms.forEach((form)=> { %>
                    <option value="<%= form.CategoriesName; %>"></option>
                    <% }); %>
                </datalist>
            </div>
  
            <div class="item-container">
              <div class="item-title">
                <label for="planned">Thông tin quy hoạch</label>
              </div>
              <input type="text" class="form-control" id="planned" value="Chưa quy hoạch" list="planList" />
                <datalist id="planList" style="display: none;">
                  <option value="Đã quy hoạch"></option>
                  <option value="Chưa quy hoạch"></option>
                </datalist>
            </div>

            <div class="button">
              <button type="submit" id="submitBtn">Xác nhận</button>
              <button type="button">Hủy và thoát</button>
            </div>
          </div>
      </form>
    </div>
    <script defer src="/js/add.js"></script>
    <script defer>
      const spottypes = JSON.parse('<%- JSON.stringify(other.spottypes) %>');
      const adsforms = JSON.parse('<%- JSON.stringify(other.adsforms) %>');
      const spottypeInput = document.getElementById('locationtype');
      const adsformInput = document.getElementById('adCategory');
      const spottypeIdInput = document.getElementById('spotType');
      const adsformIdInput = document.getElementById('adsForm');

      const districtInput = document.getElementById('district-field');
      const wardInput = document.getElementById('ward-field');
      const districtIdInput = document.getElementById('district');
      const wardIdInput = document.getElementById('ward');

      spottypeInput.addEventListener('change', (e) => {
        const spottype = spottypes.find(type => type.locationTypeName == spottypeInput.value);
        spottypeIdInput.value = spottype.locationTypeID;
      });

      adsformInput.addEventListener('change', (e) => {
        const adsform = adsforms.find(form => form.CategoriesName == adsformInput.value);
        adsformIdInput.value = adsform.CategoriesID;
      });
      

      // trigger district + ward change event
      document.addEventListener('DOMContentLoaded', (e) => {
        districtInput.dispatchEvent(new Event('change'));
        wardInput.dispatchEvent(new Event('change'));
      });

      // Hide alert on close
      document.querySelectorAll('.btn-close').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.target.parentElement.hidden = true;
          if (e.target.parentElement.id == 'alert-success') {
            window.location.href = '/department';
          }
        });
      });
    </script>
    <!-- upload picture -->
    <script defer>
      const upload2Imgur = async (files) => {
        const links = []
        console.log(files);
        for (let i = 0; i < files.length; i++) {
          let formData = new FormData()
          formData.append('image', files[i])
          const response = await fetch('/pic/posts', {
            method: 'POST',
            body: formData,
            redirect: 'follow'
          });
          const data = await response.json()
          links.push(data.message);
        }
        return links
      }

      const submitHandler = async (e) => {
        e.preventDefault();
        const districts = JSON.parse('<%- JSON.stringify(other.districts) %>');
        const wards = JSON.parse('<%- JSON.stringify(other.wards) %>');
        
        console.log(districts);
        console.log(wards);
        

        districtName = `Quận ${districtInput.value}`;
        console.log(districtName)
        const district = districts.find(district => district.districtName == districtName);
        console.log(district);
        districtIdInput.value = (district) ? district.districtID : '';
        console.log(districtIdInput.value)


        wardName = `Phường ${wardInput.value}`;
        console.log(wardName)
        const ward = wards.find(ward => ward.wardName == wardName && ward.districtID == districtIdInput.value);
        wardIdInput.value = (ward) ? ward.wardID : '';
        console.log(ward);

        // get data
        const spotName = document.getElementById('name-field').value;
        const longitude = document.getElementById('long-field').value;
        const latitude = document.getElementById('lat-field').value;
        const address = document.getElementById('address-field').value;
        const wardID = document.getElementById('ward').value;
        const districtID = document.getElementById('district').value;
        const spotType = document.getElementById('spotType').value;
        const adsForm = document.getElementById('adsForm').value;
        const planned = document.getElementById('planned').value;

        if(spotName == ''){
          document.getElementById('warning-text').textContent = "Vui lòng nhập TÊN ĐIỂM ĐẶT mới.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        if(longitude == '' || latitude == '' || address == ''){
          document.getElementById('warning-text').textContent = "Vui lòng chọn TỌA ĐỘ ĐIỂM ĐẶT trên bản đồ ở TRANG CHỦ.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        if(districtID == '' || wardID == ''){
          document.getElementById('warning-text').textContent = "Khu vực (Quận / Phường) bạn chọn không nằm trong quyền quản lý của chúng tôi, vui lòng trờ về TRANG CHỦ chọn điểm mới.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        const spottypeList = JSON.parse('<%- JSON.stringify(other.spottypes) %>');
        const adsformList = JSON.parse('<%- JSON.stringify(other.adsforms) %>');

        const spotTypeName = document.getElementById('locationtype').value.trim();
        if(spotTypeName == '' || !(spottypeList.some(type => type.locationTypeName === spotTypeName))){
          document.getElementById('warning-text').textContent = "Vui lòng nhập đúng LOẠI VỊ TRÍ.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        const adsFormName = document.getElementById('adCategory').value.trim();
        if(adsFormName == '' || !(adsformList.some(form => form.CategoriesName === adsFormName))){
          document.getElementById('warning-text').textContent = "Vui lòng nhập đúng HÌNH THỨC QUẢNG CÁO.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        if(planned != 'Đã quy hoạch' && planned != 'Chưa quy hoạch'){
          document.getElementById('warning-text').textContent = "Vui lòng nhập đúng THÔNG TIN QUY HOẠCH.";
          document.getElementById('alert-warning').hidden = false;
          return;
        }

        //const inputImage = document.getElementById('input-image');
        const files = input.files;
        console.log(files);
        const imgUrls = await upload2Imgur(files);
        
        const data = {
          locationName: spotName,
          longitude: longitude,
          latitude: latitude,
          address: address,
          wardID: wardID,
          districtID: districtID,
          locationType: spotType,
          adsForm: adsForm,
          planned: (planned == 'Đã quy hoạch') ? 1 : 0,
          images: imgUrls
        };

        const url = '<% url %>'
        const result = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data),
        });
        
        console.log(result);
        if (result.status == 200) {
          document.getElementById('alert-success').hidden = false;
          // clear all input
          document.querySelectorAll('input').forEach((input) => {
            input.value = '';
          });
        } else {
          document.getElementById('alert-danger').hidden = false;
        }

        loader.style.display = 'none';
      }

      document.getElementById('submitBtn').addEventListener('click', submitHandler);
    </script>
  </body>
</html>